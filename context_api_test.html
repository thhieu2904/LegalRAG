<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Context API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Context Management API Test</h1>

      <div class="test-section">
        <h3>Step 1: Send Test Message (Create Session)</h3>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <div id="messageResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>Step 2: Get Session Context</h3>
        <button onclick="getSessionContext()" id="getContextBtn" disabled>
          Get Session Context
        </button>
        <div id="contextResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>Step 3: Reset Session Context</h3>
        <button onclick="resetSessionContext()" id="resetBtn" disabled>
          Reset Context
        </button>
        <div id="resetResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>Session Info</h3>
        <div>Session ID: <span id="sessionId">None</span></div>
        <div>
          Backend URL: <span id="backendUrl">http://localhost:8000</span>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      const BASE_URL = "http://localhost:8000";

      function log(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error"
            ? "result error"
            : type === "success"
            ? "result success"
            : "result";
        element.className = className;
        element.textContent = `[${timestamp}] ${message}`;
      }

      function updateSessionId(sessionId) {
        currentSessionId = sessionId;
        document.getElementById("sessionId").textContent = sessionId || "None";

        // Enable/disable buttons based on session
        document.getElementById("getContextBtn").disabled = !sessionId;
        document.getElementById("resetBtn").disabled = !sessionId;
      }

      async function sendTestMessage() {
        log("messageResult", "Sending test message...");

        try {
          const response = await fetch(`${BASE_URL}/api/v2/optimized-query`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              query: "T√¥i mu·ªën h·ªèi v·ªÅ lu·∫≠t lao ƒë·ªông",
              session_id: null,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          updateSessionId(data.session_id);

          log(
            "messageResult",
            `SUCCESS!\n` +
              `Session ID: ${data.session_id}\n` +
              `Type: ${data.type}\n` +
              `Processing Time: ${data.processing_time}s\n` +
              `Answer Preview: ${data.answer?.substring(0, 100)}...`,
            "success"
          );
        } catch (error) {
          log("messageResult", `ERROR: ${error.message}`, "error");
        }
      }

      async function getSessionContext() {
        if (!currentSessionId) {
          log("contextResult", "No session ID available", "error");
          return;
        }

        log("contextResult", "Fetching session context...");

        try {
          const response = await fetch(
            `${BASE_URL}/api/v2/session/${currentSessionId}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          log(
            "contextResult",
            `SUCCESS!\n` +
              `Session ID: ${data.session_id}\n` +
              `Query Count: ${data.query_count}\n` +
              `Context Summary:\n${JSON.stringify(
                data.context_summary,
                null,
                2
              )}`,
            "success"
          );
        } catch (error) {
          log("contextResult", `ERROR: ${error.message}`, "error");
        }
      }

      async function resetSessionContext() {
        if (!currentSessionId) {
          log("resetResult", "No session ID available", "error");
          return;
        }

        log("resetResult", "Resetting session context...");

        try {
          const response = await fetch(
            `${BASE_URL}/api/v2/session/${currentSessionId}/reset`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          log(
            "resetResult",
            `SUCCESS!\n` +
              `Message: ${data.message}\n` +
              `Context Summary After Reset:\n${JSON.stringify(
                data.context_summary,
                null,
                2
              )}`,
            "success"
          );
        } catch (error) {
          log("resetResult", `ERROR: ${error.message}`, "error");
        }
      }

      // Test backend connection on load
      window.onload = async function () {
        try {
          const response = await fetch(`${BASE_URL}/api/v2/health`);
          if (response.ok) {
            document.getElementById("backendUrl").style.color = "green";
            document.getElementById("backendUrl").textContent +=
              " ‚úÖ Connected";
          } else {
            throw new Error("Backend not responding");
          }
        } catch (error) {
          document.getElementById("backendUrl").style.color = "red";
          document.getElementById("backendUrl").textContent +=
            " ‚ùå Disconnected";
        }
      };
    </script>
  </body>
</html>
